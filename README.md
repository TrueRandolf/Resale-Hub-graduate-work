# Marketplace Backend (Дипломный проект)

Платформа для размещения объявлений и управления профилями пользователей.

##  Текущий статус и Качество кода
*   **Функционал**: Реализован в полном объеме (REST API, Security, Image Storage).
*   **Тестирование**: Проект прошел глубокое интеграционное и модульное тестирование.
*   **Покрытие кода (Line Coverage)**: **80%** (подтверждено инструментами анализа покрытия IDE).


##  Ключевые этапы реализации
- [x] Спроектированы DTO и модели данных (JPA Entities).
- [x] Реализован слой контроллеров (REST API) согласно спецификации OpenAPI.
- [x] Реализован персистентный слой и миграции базы данных (Liquibase).
- [x] Внедрена ролевая модель доступа (Spring Security + BCrypt).
- [x] Реализована бизнес-логика сервисов с низким уровнем связности (Low Coupling).
- [x] Достигнуто целевое покрытие тестами (JUnit 5, Mockito, MockMvc).


##  Технологический стек
* **Java 11** (Amazon Corretto)
* **Spring Boot 2.7.15** (Web, Validation, Security, Data JPA)
* **PostgreSQL 17** — основная БД.
* **Liquibase** — управление миграциями.
* **MapStruct & Lombok** — автоматизация маппинга и генерация шаблонного кода.
* **OpenAPI 3 (Swagger)** — интерактивная документация эндпоинтов.
* **JUnit 5, Mockito, AssertJ** — стек тестирования.

##  Архитектура приложения
Проект использует **многоуровневую архитектуру** (Layered Architecture):
*   `controller`: Точки входа API, обработка HTTP-запросов.
*   `service`: Реализация бизнес-логики, проверка прав доступа (security) и координация данных.
*   `repository`: Взаимодействие с базой данных (JPA).
*   `security`: Конфигурация доступа, аутентификация и авторизация.
*   `mappers`: Преобразование данных между слоями (Entity - DTO).
*   `exceptions`: Централизованная обработка ошибок (`@RestControllerAdvice`).

## Обзор основного API

Доступ к эндпоинтам разграничен согласно ролевой модели (User / Admin). Полная интерактивная документация доступна в Swagger UI.

*   **Auth (Авторизация)**: Регистрация и аутентификация пользователей. Доступна без аутентификации.
*   **Users (Пользователи)**: Управление личным профилем, смена пароля и аватара. Доступно автору/админу.  
*   **Ads (Объявления)**: Просмотр (любой авторизованный пользователь), создание, редактирование и удаление (автор/админ), загрузка изображений.
*   **Comments (Комментарии)**: Просмотр (любой авторизованный пользователь), добавление, редактирование и удаление отзывов к товарам (автор/админ).


## Расширенный  функционал (Management API)

В рамках расширения проекта реализован специализированный контроллер для управления данными:

*   **Soft Delete & Anonymization**: Механизм «мягкого» удаления пользователя с анонимизацией данных и подменой имени автора (Deleted user) в архиве комментариев.
*   **Hard Delete (Cascade)**: Полное каскадное удаление пользователя со всеми его объявлениями, комментариями, файлами на диске и данными аутентификации.
*   **Мониторинг**: Получение сводной статистики по активным и удаленным (Soft Delete) учетным записям.


##  Инструкция по развертыванию и запуску

### 1. Предварительные требования
* **JDK 11** (например, Amazon Corretto)
* **Maven 3.6+**
* **PostgreSQL** (убедитесь, что служба запущена)

### 2. Подготовка базы данных
Создайте пустую базу данных в PostgreSQL:
```sql
CREATE DATABASE resale_db;
```
Структура таблиц будет создана автоматически при первом запуске через Liquibase.

### 3. Настройка окружения
Отредактируйте параметры подключения в файле ```src/main/resources/application.yaml:```
Укажите ваши username и password от локального PostgreSQL.
Проверьте путь к хранилищу изображений (параметр ``app.upload.main-dir``). Убедитесь, что у приложения есть права на запись в эту папку.
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/resale_db
    username: postgres # укажите ваш логин
    password: password # укажите ваш пароль
  liquibase:
    enabled: true
 ```
### 4. Сборка и запуск
#### Сборка и пропуск тестов (для быстрого старта).
Из корневой директории проекта выполните:
```bash
mvn clean install -DskipTests
```
#### Запуск приложения
```bash
mvn spring-boot:run
```
#### Тестирование и Coverage
Запуск теста и проверка отчета о покрытии (80% Line Coverage):
```bash
mvn clean verify
```

### Интеграция с фронтендом
Приложение разработано для работы в связке с фронтенд-частью (React).
* **Порт фронтенда**: `http://localhost:3000`
* **CORS**: В приложении настроены разрешения для кросс-доменных запросов с порта 3000.
* **Docker**: Если вы запускаете фронтенд через Docker, убедитесь, что контейнеры находятся в одной сети или проброшены соответствующие порты.

### Документация API
После запуска интерактивная документация Swagger UI доступна по адресу:
http://localhost:8080/swagger-ui/index.html


##  Визуализация
### Схема базы данных
![DB Schema](docs/resale_db_public.png)

### Диаграмма классов
![UML Diagram](/docs/class_diagram.jpg)
---

* **Козлов Роман https://github.com/TrueRandolf** — Java Developer.
    * Проектирование архитектуры и базы данных.
    * Реализация бизнес-логики и системы безопасности.
    * Полное покрытие проекта интеграционными тестами (80% Line Coverage).
    * Настройка миграций и документации API.
    * Интеграция бэкенда с фронтенд-приложением (Docker, CORS).
